## はじめに

FE においてレンダー、レンダリングという言葉はさまざまな場面で登場しますよね。
自分はなんとなく描写する、画面上に表示するというイメージでレンダーと口にしていたのですが、例えば SSR におけるレンダリングって表示していると言えるのでしょうか

## 要約

レンダリングの意味

- 広義
  - データを計算して変換すること
- ブラウザ
  - Web コンテンツを画面に描写すること
- React
  - コンポーネントを呼び出す(実行する)こと
- CSR
  - ブラウザ上で DOM を書き換えること
- 事前レンダリング(SSR/SSG)
  - HTML ファイルを生成すること

## レンダリングの広義的な意味

**意味. データ、情報を計算して、(人間が理解可能な形式へ)変換すること**

Web フロントエンド以外でも、3DCG、動画、音声(作曲)のようなデータを取り扱う分野の用語としてもレンダリングという言葉は使われています。

> - 3DCG: モデルやシーンの 3D データを計算し画像や映像として出力すること
> - 動画: 各フレームを順番に描画して最終的なビデオクリップを生成すること。
> - 音声（作曲）: 複数の MIDI データやデジタルオーディオ信号を音声ファイルデータ(mp3 など)として出力すること。

これらの用語では共通して、**データ情報を計算して、(人間が理解可能な形式へ)データへ変換すること**という意味合いを持ち合わせていそうです。

フロントエンドの文脈では、人間が近く可能な視覚的な情報として画面上に要素を描写することという意味合いになり、レンダリングという言葉は画面へ要素を表示するための過程の一過程であると考えることができるのではないでしょうか。

## ブラウザにおけるレンダリング(The Pixel Pipeline)

**意味. HTML(あるいは DOM)を画面に描写すること**

ブラウザではレンダリングエンジンがコンテンツ(HTML など)を受け取って内容を描画しています。レンダリングエンジンの処理工程は、The Pixel Pipeline と呼ばれ、詳しくは以下の記事が参考になります。(コンテンツが動的に更新されるということがウェブの特徴であり、そのためいくつかの中間表現を持っています)

https://web.dev/articles/rendering-performance

レンダリングエンジンは最終的に OS のグラフィックライブラリへパースしたものを渡すことになるので、レンダリングエンジンというレイヤーが行なっているレンダリングの役割は、**グラフィックライブラリに描画したものを渡すこと** と言えるかもしれません。
しかし、多くの文脈において、レンダリングエンジン以降のレイヤーでモニターに表示されるまでの処理を深く気にする必要はないので、ブラウザレンダリングとは、単純に HTML、DOM を画面に描写すること と捉えても差し支えないと思われます。(後述する React においては、ブラウザレンダリングは混乱を避けるために このことは Paint と呼ばれています。)

## React におけるレンダー

**意味. React がコンポーネントを呼び出すこと**

これは React の公式ドキュメントにも以下のように明記されています。なお、コンポーネントを呼び出すことを実行すること、と解釈しても大きな齟齬はないと思われます。(英語ではレンダーではなく Rendering となっています。)

> レンダーとは React がコンポーネントを呼び出すことです
> “Rendering” is React calling your components.

https://ja.react.dev/learn/render-and-commit

https://react.dev/learn/render-and-commit

そして、React では以下のような 4 つのフェーズに分けて、インタラクティブな要素が画面に再描画されます。

- **トリガー**
  - Set 関数など、レンダーをトリガーする。
- **レンダーフェーズ**
  - レンダー(コンポーネントの呼び出し)が行われる
- **コミットフェーズ**
  - レンダー間で差があった場合のみ DOM ノード を変更する
- **ペイント(ブラウザレンダリング)**
  - ブラウザが画面を再描画する。(React の責務ではない)

つまり、React ではレンダー(コンポーネントに呼び出し)がされたとしても、ReactTree(仮想 DOM)上で差分がなければ DOM が更新されず、画面には反映されないということになります。

## レンダリングパターンにおけるレンダリング(CSR/SSR/SSG/SPA)

**_前書き_**
CSR(Client-side-rendering)、SSR(Server-side-rendering)、SSG(Static-site-generator/Pre-rendering)などと言った用語はレンダリングパターンの用語として利用されます。
これらの用語はそれぞれ概念を表す言葉なので、SSR の R の部分の意味について切り出して考えるのも少々的を射ていない話かもしれませんが、概ねページ(コンテンツ)の生成の仕方が焦点にあたってきた経緯があります。
レンダリングの意味は、**ページのコンテンツの生成**であり、CSR(海外の SPA)だと要素を生成して DOM に追加、更新すること、事前レンダリングでは特に HTML ファイルそのものの生成 を指していると捉えることができそうです。
事前レンダリング(Pre-rendering = SSR/SSG)という概念は、CSR でそれが行われた時(つまり事前にレンダリングされていない時)との対比として、**クライアントサイドで実行されるコードをサーバーサイドで実行する**という意味合いが含まれてきます。

(※ページ規模ではない用例として、isomorphic なコンポーネントがサーバー側で実行されることを SSR、クライアント側で実行されることを CSR などとライトに使われているところを耳にすることがあります。)

## CSR におけるレンダリング

**意味. ページの描写時に、クライアントサイドで javaScript によってコンテンツを生成し DOM を更新すること**
CSR という言葉は初期表示でも画面回遊時(ナビゲーション時)でも使われ、CSR でのナビゲーションは特にソフトナビゲーションと呼ばれます。(対照的に MPA 的遷移はハードナビゲーションと言います。)
CSR というモデルが出る以前は、コンテンツを含む HTML と、ページをインタラクティブにするために JQuery などのファイルを別々に作成するのが主流でした。ページ遷移の際も、新たな HTML ファイルが送られてくることになります。
一方で、 ナビゲーションが CSR で行われる場合は、HTML ファイルではなく js や json のデータがサーバーから送られ、クライアントサイドでスクリプトが実行されコンテンツが生成されます。初期表示が CSR である場合はコンテンツが空の HTML が送られてきたのちに、ナビゲーション時と同様の流れでスクリプトが読み込まれ、コンテンツ用のデータを 取得してくるような流れで描写されます。

ただし、この頃のサイト訪問時に空の HTML を返すアプリケーションの欠点の一つに、SEO 対策が困難であるという点がありました。(他にもパフォーマンス面やデータ転送面などの欠点もあります。)

> この頃の従来の MVC のようなモデルなどをレトロニム的に SSR と呼ぶこともあったようです。

## SPA(Single-page-application)

ここで SPA について触れておきたいと思います。SPA という用語の使われ方は大きく分けて二つに分かれているように思えます。

1. ソフトナビゲーションで画面回遊するアプリケーション全般(SSR/SSG と共存する概念)
2. CSR のみの事前レンダリングをしないアプリケーション(SSR/SSG と排他的関係の概念)

1 については、HTML ファイルがサイト訪問時の一回を除いては２度と送られてこないアプリケーションということになり、ページごとに HTML ファイルを都度配信する MPA(Multi-page-application)との対比として捉えることができそうです。

2 については、事前レンダリングをしない、サーバーサイドのランタイムを持たない CSR のみのアプリケーションということになります。

こちらの用例は海外で特に見られる傾向にあり、例えば state of javascript のアンケートでの SPA の定義や Remix の SPA モードの意味でも、MPA 含め SSR/SSG と横並びになるようなこちらの意味で使われています。

> SPA: Apps that run entirely in the browser
> MPA: Apps that run entirely in the server, with minimal client-side dynamic behavior
> (state of javascript 2024)

## 事前レンダリング(SSR/SSG)におけるレンダリング

**意味. ① クライアントサイドでも動作するコードをサーバーサイド(\*)で実行して ②HTML ファイルを(サーバーサイドで)生成すること**

SSR と SSG という用語は「SSR 時」「SSG 時」のように事前レンダリングが実行されている瞬間を指すこともありますが、そのようなレンダリングパターンを持つモデルそのものを指すこともあります。
事前という言葉はレスポンス前のタイミングであると解釈できます。

| SSG      | SSR                  |
| -------- | -------------------- |
| build 時 | リクエスト時(訪問時) |

このレンダリングパターンの利点として、 CSR のみのアプリケーション(CRA など) と比較して、初期表示やハードナビゲーションのような場面でも、コンテンツを含む HTML ファイルを生成して送ることができる点 があげられます。

### SSR/SSG であるもの、ないもの

### サーバーサイドテンプレートは SSR/SSG か

SSR/SSG が「事前に HTML ファイルを生成するモデル」と定義するなら、SpringBoot や Rails などのサーバーサイドテンプレートをはじめ、SPA 以前のモデル全ても SSR/SSG であると捉えることもできそうですが、昨今はあまりこう言ったモデルに対しては SSR/SSG という言葉は使われません。

:::message
(CSR が出てきた当初レトロニム的にサーバー側でコンテンツを生成していたモデルを SSR と使われたりしていたことはあったみたいです。)
:::

昨今主流の SSR フレームワーク登場の経緯として、React や Vue のようなクライアントサイドで動いていたコードを、サーバーサイドで実行(レンダー)して HTML を事前に生成するという意味合いがあるためです。そして、それらのコードはソフトナビゲーション時には従来通りクライアントサイドで実行されます。つまり、事前レンダリングという言葉が使われる場面ではコードは必然的に isomolphic になり、hydration などといった概念がセットになってくることがほとんどです。

(CSR のレトロニム的に SSR という言葉が使われており、その意味では昨今の Remix や Nuxt を SSR with hydration と表現するのはこのためだと思われます。)

### RSC(React-server-component)は SSR か

RSC の SC(サーバーコンポーネント)は SSR であるかということについては React 公式も、RSC と SSR は両立する別の概念であるとしています。
確かに SC はサーバーサイドでのみレンダーされるものですが、SSR は、CC(クライアントコンポーネント)や SharedComponent を含めてサーバーサイドで実行して HTML を生成することだからです。

> **Does this replace SSR?**
> No, they’re complementary. SSR is primarily a technique to quickly display a non-interactive version of client components.

https://github.com/reactjs/rfcs/blob/main/text/0188-server-components.md#does-this-replace-ssr

### SSR の誕生

SSR フレームワークの初出と考えられそうな候補として Backbone.js の Rendr があります。Backbone.js は最古の SPA フレームワークで、クライアントサイド MVC モデルが採用されています。

当初の CSR のアプリケーションは、SEO 対策のために、別言語(Ruby など)で二重開発をして初回アクセス時にはサーバーサイドで HTML ファイルを生成したり、ヘッドレスブラウザのようなものを挟み、そこで js を実行して HTML を生成するなどの対応をしていたようです。

ダイナミックレンダリング
https://developers.google.com/search/docs/crawling-indexing/javascript/dynamic-rendering?hl=ja

js を実行して HTML を生成してくれるサービス
https://prerender.io/

そこで Rendr が取ったアプローチが、nodejs を採用し、Ruby との二重開発で共通していたロジックは Isomolphic(サーバーサイド/クライアントサイドどちらでも実行できる)なコードとすることでした。
なお、Rendr の作者の Rendr の公開スライドに、すでに hydrate という言葉が出ていることから、クライアントサイドで要素をインタラクティブにするフェーズを hydrate という文化はこの時にはすでに存在していたようです。

以下の Render の記事は React が公開される 2013 年 5 月よりも前のものなので、React の事前レンダリングが普及される遥か前にすでに SSR フレームワークが一度完成していたと言っても良いかもしれません。

https://medium.com/airbnb-engineering/our-first-node-js-app-backbone-on-the-client-and-server-c659abb0e2b4

https://www.slideshare.net/slideshow/introducing-rendr-run-your-backbonejs-apps-on-the-client-and-server/19106546
